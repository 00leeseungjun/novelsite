<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <link rel="stylesheet" href="/adminUsers.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> 
</head>
<body>
    <div class="admin-wrap">
        <%- include('parts/admin_sidebar', { user: user }) %>
        
        <main class="admin-main-content">
            <h1>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h1>
            <p>ì´ **<%= users.length %>ëª…**ì˜ ì‚¬ìš©ì ëª©ë¡ì…ë‹ˆë‹¤. ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ë‹‰ë„¤ì„</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ê¶Œí•œ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach(userItem => { %>
                        <tr id="user-<%= userItem.id %>">
                            <td><%= userItem.id %></td>
                            <td><%= userItem.nickname %></td>
                            <td><%= userItem.email %></td>
                            <td>
                                <span class="badge <%= userItem.isAdmin ? 'badge-admin' : 'badge-user' %>">
                                    <%= userItem.isAdmin ? 'ê´€ë¦¬ì' : 'ì¼ë°˜' %>
                                </span>
                            </td>
                            <td>
                                <button 
                                    class="btn-delete" 
                                    data-user-id="<%= userItem.id %>"
                                    data-is-admin="<%= userItem.isAdmin %>"
                                    <%= userItem.id === user.id || userItem.isAdmin ? 'disabled' : '' %>
                                >
                                    ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </main>
    </div>

    <script>
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', async function() {
                const userId = this.dataset.userId;
                const isAdmin = this.dataset.isAdmin;
                
                if (isAdmin === '1') {
                    alert('ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§„ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                if (confirm(`[${userId}] ì‚¬ìš©ìë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê²½ê³ : ì´ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ëª¨ë“  ì‘í’ˆ, ì—í”¼ì†Œë“œ, ëŒ“ê¸€, ì¢‹ì•„ìš” ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                    try {
                        const response = await axios.post(`/admin/user/delete/${userId}`);
                        
                        if (response.data.success) {
                            alert(response.data.message);
                            // ì„±ê³µ ì‹œ ëª©ë¡ì—ì„œ í•´ë‹¹ í–‰ ì œê±°
                            document.getElementById(`user-${userId}`).remove();
                        } else {
                            alert(`ì‚­ì œ ì‹¤íŒ¨: ${response.data.message}`);
                        }
                    } catch (error) {
                        console.error('ì‚­ì œ ìš”ì²­ ì˜¤ë¥˜:', error);
                        // HTTP ì‘ë‹µì´ 400, 500 ë“± ì˜¤ë¥˜ì¼ ê²½ìš° ë©”ì‹œì§€ ì¶œë ¥
                        alert(error.response.data.message || 'ì‚­ì œ ìš”ì²­ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            });
        });
    </script>
</body>
</html>